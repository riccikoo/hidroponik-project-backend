<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat - HydroGrow</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo-putih.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/riwayat.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- ====== SIDEBAR ====== -->
    <div class="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', filename='img/logo-putih.png') }}" alt="HydroGrow Logo" class="logo-img">
            <h2>HydroGrow</h2>
        </div>
        <nav>
            <a href="/dashboard" class="nav-item">
                <span class="icon">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                </span>
                <span>Dashboard</span>
            </a>
            <a href="/riwayat" class="nav-item active">
                <span class="icon">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </span>
                <span>Riwayat</span>
            </a>
            <a href="/profile" class="nav-item">
                <span class="icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="8" r="4"/>
                        <path d="M20 21a8 8 0 1 0-16 0"/>
                    </svg>
                </span>
                <span>Profile</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <a href="/logout" class="logout-btn">
                <span class="icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </span>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- ====== MAIN CONTENT ====== -->
    <div class="main-content">

        <!-- Header -->
        <header>
            <div class="header-left">
                <h1>Riwayat & Notifikasi</h1>
                <p>Histori data sensor dan notifikasi sistem hidroponik</p>
            </div>
            <div class="header-right">
                <div class="connection-status">
                    <span class="status-dot active"></span>
                    <span>ESP32 Connected</span>
                </div>
                <a href="/profile" style="text-decoration: none; color: inherit;">
                    <div class="user-profile">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>Halo, {{ user_name }}!</span>
                    </div>
                </a>
            </div>
        </header>

        <!-- ====== NOTIFICATIONS & ALERTS (PALING ATAS!) ====== -->
        <section class="notifications-section">
            <h2>
                <svg viewBox="0 0 24 24">
                    <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 01-3.46 0"/>
                </svg>
                Notifikasi & Alert Terbaru
            </h2>
            <div class="notification-list">
                {% if notifications and notifications|length > 0 %}
                    {% for notif in notifications %}
                    <div class="notification-item {{ notif.type }}">
                        <span class="notif-icon">
                            {% if notif.type == 'info' %}
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            {% elif notif.type == 'warning' %}
                            <svg viewBox="0 0 24 24">
                                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            {% elif notif.type == 'success' %}
                            <svg viewBox="0 0 24 24">
                                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            {% else %}
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            {% endif %}
                        </span>
                        <div class="notif-content">
                            <strong>{{ notif.title }}</strong>
                            <p>{{ notif.message }}</p>
                            <small>{{ notif.time_ago }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="notification-item info">
                    <span class="notif-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                    </span>
                    <div class="notif-content">
                        <strong>Tidak Ada Notifikasi</strong>
                        <p>Semua sistem berjalan normal</p>
                        <small>Sekarang</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- ====== FILTER SECTION ====== -->
        <section class="filter-section">
            <div class="filter-container">
                <div class="filter-group">
                    <label>
                        <svg viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Rentang Waktu
                    </label>
                    <select id="time-range" class="filter-select">
                        <option value="today">Hari Ini</option>
                        <option value="yesterday">Kemarin</option>
                        <option value="week" selected>7 Hari Terakhir</option>
                        <option value="month">30 Hari Terakhir</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>
                        <svg viewBox="0 0 24 24">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        Jenis Sensor
                    </label>
                    <select id="sensor-type" class="filter-select">
                        <option value="all" selected>Semua Sensor</option>
                        <option value="temperature">Suhu</option>
                        <option value="humidity">Kelembapan</option>
                        <option value="ph">pH Air</option>
                        <option value="ec">EC (Nutrisi)</option>
                        <option value="light">Cahaya</option>
                        <option value="water">Level Air</option>
                    </select>
                </div>

                <button class="btn-filter">
                    <svg viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    Terapkan Filter
                </button>

                <button class="btn-export">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export CSV
                </button>
            </div>
        </section>

        <!-- ====== STATISTICS CARDS ====== -->
        <section class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon temp">
                    <svg viewBox="0 0 24 24">
                        <path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>Suhu Rata-rata</h3>
                    <p class="stat-value">{{ avg_temp|round(1) }}°C</p>
                    <span class="stat-change {{ 'positive' if temp_change > 0 else 'negative' if temp_change < 0 else 'stable' }}">
                        <svg viewBox="0 0 24 24">
                            {% if temp_change > 0 %}
                            <polyline points="18 15 12 9 6 15"/>
                            {% elif temp_change < 0 %}
                            <polyline points="6 9 12 15 18 9"/>
                            {% else %}
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            {% endif %}
                        </svg>
                        {{ temp_change|abs|round(1) }}°C dari kemarin
                    </span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon humidity">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>Kelembapan Rata-rata</h3>
                    <p class="stat-value">{{ avg_humidity|round(1) }}%</p>
                    <span class="stat-change {{ 'positive' if humidity_change > 0 else 'negative' if humidity_change < 0 else 'stable' }}">
                        <svg viewBox="0 0 24 24">
                            {% if humidity_change > 0 %}
                            <polyline points="18 15 12 9 6 15"/>
                            {% elif humidity_change < 0 %}
                            <polyline points="6 9 12 15 18 9"/>
                            {% else %}
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            {% endif %}
                        </svg>
                        {{ humidity_change|abs|round(1) }}% dari kemarin
                    </span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon ph">
                    <svg viewBox="0 0 24 24">
                        <path d="M9 11a3 3 0 106 0"/>
                        <path d="M9.7 20.7l-3.4-3.4a7.6 7.6 0 010-10.6l3.4-3.4 3.4 3.4a7.6 7.6 0 010 10.6l-3.4 3.4z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>pH Rata-rata</h3>
                    <p class="stat-value">{{ avg_ph|round(1) }}</p>
                    <span class="stat-change stable">
                        <svg viewBox="0 0 24 24">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Stabil
                    </span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon ec">
                    <svg viewBox="0 0 24 24">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                        <polyline points="17 6 23 6 23 12"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>EC Rata-rata</h3>
                    <p class="stat-value">{{ avg_ec|round(1) }} mS/cm</p>
                    <span class="stat-change positive">
                        <svg viewBox="0 0 24 24">
                            <polyline points="18 15 12 9 6 15"/>
                        </svg>
                        Normal
                    </span>
                </div>
            </div>
        </section>

        <!-- ====== HISTORY TABLE ====== -->
        <section class="history-section">
            <div class="section-header">
                <h2>
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    Data Riwayat Sensor
                </h2>
                <div class="table-actions">
                    <button class="btn-refresh">
                        <svg viewBox="0 0 24 24">
                            <polyline points="23 4 23 10 17 10"/>
                            <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Suhu</th>
                            <th>Kelembapan</th>
                            <th>pH</th>
                            <th>EC</th>
                            <th>Cahaya</th>
                            <th>Level Air</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if sensor_data and sensor_data|length > 0 %}
                            {% for data in sensor_data %}
                            <tr>
                                <td>
                                    <div class="time-cell">
                                        <strong>{{ data.created_at.strftime('%d %b %Y') }}</strong>
                                        <span>{{ data.created_at.strftime('%H:%M:%S') }}</span>
                                    </div>
                                </td>
                                <td>{{ data.suhu }}°C</td>
                                <td>{{ data.kelembapan }}%</td>
                                <td>{{ data.ph }}</td>
                                <td>{{ data.ec }}</td>
                                <td>{{ data.cahaya }} lux</td>
                                <td>{{ data.level_air }}%</td>
                                <td>
                                    {% if data.suhu > 30 or data.ph < 6 or data.ph > 7 %}
                                    <span class="badge danger">Bahaya</span>
                                    {% elif data.suhu > 28 or data.ph < 6.2 %}
                                    <span class="badge warning">Warning</span>
                                    {% else %}
                                    <span class="badge normal">Normal</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 30px;">
                                <p style="color: #999;">Belum ada data sensor tersimpan</p>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        // Filter button
        document.querySelector('.btn-filter')?.addEventListener('click', function() {
            const timeRange = document.getElementById('time-range').value;
            const sensorType = document.getElementById('sensor-type').value;

            // Redirect with query parameters
            window.location.href = `/riwayat?time_range=${timeRange}&sensor_type=${sensorType}`;
        });

        // Export CSV
        document.querySelector('.btn-export')?.addEventListener('click', function() {
            window.location.href = '/riwayat/export';
        });

        // Refresh button
        document.querySelector('.btn-refresh')?.addEventListener('click', function() {
            this.querySelector('svg').style.transform = 'rotate(360deg)';
            this.querySelector('svg').style.transition = 'transform 0.5s';
            setTimeout(() => {
                location.reload();
            }, 500);
        });

        // Sidebar navigation active state
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-item').forEach(item => {
                const href = item.getAttribute('href');
                item.classList.remove('active');
                if (href === currentPath) {
                    item.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>